<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ workflow.nome }} - Análise JP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Space Grotesk', 'Segoe UI', '-apple-system', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(15, 23, 42, 0.65);
        }

        .glass-panel {
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease forwards;
        }

        .scale-in {
            animation: scaleIn 0.45s ease forwards;
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(14px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            0% {
                opacity: 0;
                transform: scale(0.94);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="{{ theme.bg }} {{ theme.text }} font-sans h-screen overflow-hidden">
    <div class="flex h-full">
        {% include 'partials/sidebar.html' %}

        <main class="flex-1 h-full overflow-y-auto">
            <div class="max-w-7xl mx-auto px-6 md:px-10 py-10 space-y-8">
                <header class="glass-panel {{ theme.modal }} border border-white/5 rounded-3xl p-8 shadow-2xl shadow-emerald-500/10">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                        <div class="space-y-4">
                            <div class="flex items-center gap-4">
                                <a href="/dashboard" class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-white/10 hover:border-white/30 transition-colors duration-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                                    </svg>
                                </a>
                                <div>
                                    <p class="text-sm uppercase tracking-[0.35em] text-white/50">Workflow</p>
                                    <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">{{ workflow.nome }}</h1>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide {{ theme.badge[workflow.tipo] }}">
                                    {{ {'balancete': 'Balancete', 'analise_jp': 'Análise JP'}.get(workflow.tipo, workflow.tipo.replace('_', ' ').title()) }}
                                </span>
                            </div>
                            <p class="text-white/70 max-w-3xl leading-relaxed">
                                {{ workflow.descricao or 'Ambiente dinâmico para uploads e leitura inteligente das categorias da Análise JP.' }}
                            </p>
                            <p class="text-xs text-white/40 uppercase tracking-widest">
                                Criado em {{ workflow.data_criacao.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                        </div>
                        <div class="glass-panel border border-white/10 rounded-2xl px-5 py-4 text-sm min-w-[220px]">
                            <p class="text-xs uppercase tracking-wider text-white/40">Categoria ativa</p>
                            <p id="activeCategoryLabel" class="text-sm font-medium text-white/80">-</p>
                            <p class="text-xs text-white/40 mt-1">Selecione uma categoria para visualizar os dados enviados.</p>
                        </div>
                    </div>
                </header>

                <section class="grid grid-cols-1 xl:grid-cols-4 gap-6">
                    <aside class="glass-panel {{ theme.modal }} border border-white/5 rounded-3xl p-6 space-y-5 h-full">
                        <div>
                            <h2 class="text-xl font-semibold tracking-tight">Categorias</h2>
                            <p class="text-sm text-white/60 mt-1">Escolha uma categoria para gerenciar uploads e visualizar tabelas.</p>
                        </div>
                        <div id="categoryList" class="flex flex-col gap-2"></div>
                    </aside>

                    <div class="xl:col-span-3 space-y-6">
                        <div class="glass-panel {{ theme.modal }} border border-white/5 rounded-3xl p-6 space-y-4">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <h2 class="text-2xl font-semibold tracking-tight" id="categoryTitle">Selecione uma categoria</h2>
                                    <p id="categorySubtitle" class="text-sm text-white/60 mt-1">Envie um arquivo CSV ou XLSX para liberar a visualização dos dados.</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button id="refreshButton" class="hidden {{ theme.buttons.secondary }} px-4 py-2.5 rounded-full text-sm uppercase tracking-wide transition-transform duration-300 hover:-translate-y-0.5">
                                        Atualizar lista
                                    </button>
                                    <button id="chartsButton" class="{{ theme.buttons.secondary }} px-5 py-2.5 rounded-full text-sm uppercase tracking-wide transition-transform duration-300 hover:-translate-y-0.5">
                                        Área de gráficos
                                    </button>
                                    <button id="uploadButton" class="{{ theme.buttons.primary }} px-5 py-2.5 rounded-full text-sm uppercase tracking-wide flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <span>Enviar arquivo</span>
                                        <span id="uploadSpinner" class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel {{ theme.modal }} border border-white/5 rounded-3xl p-6 space-y-4">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <div>
                                    <h3 class="text-xl font-semibold tracking-tight">Arquivos enviados</h3>
                                    <p class="text-sm text-white/60">Selecione um arquivo para visualizar os dados na tabela dinâmica.</p>
                                </div>
                                <div id="activeUploadInfo" class="text-sm text-white/60"></div>
                            </div>
                            <div id="uploadsLoading" class="hidden text-sm text-white/60">Carregando uploads...</div>
                            <div id="uploadsEmptyState" class="border border-dashed border-white/10 rounded-2xl p-8 text-center space-y-3 text-white/60">
                                <h4 class="text-lg font-semibold text-white/80">Nenhum upload encontrado</h4>
                                <p class="text-sm">Envie um arquivo para visualizar os dados extraídos.</p>
                            </div>
                            <div id="uploadsList" class="space-y-3"></div>
                        </div>

                        <div class="glass-panel {{ theme.modal }} border border-white/5 rounded-3xl p-6 space-y-5">
                            <div>
                                <h3 class="text-xl font-semibold tracking-tight">Tabela dinâmica</h3>
                                <p id="tableSubtitle" class="text-sm text-white/60">Selecione um upload para visualizar os dados extraídos.</p>
                            </div>
                            <div id="tableEmptyState" class="border border-dashed border-white/10 rounded-2xl p-10 text-center space-y-3 text-white/60">
                                <div class="w-12 h-12 mx-auto rounded-full border border-white/15 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <p>Nenhum upload selecionado.</p>
                            </div>
                            <div id="tableLoading" class="hidden border border-dashed border-white/10 rounded-2xl p-8 text-center space-y-3 text-white/60">
                                <div class="mx-auto w-10 h-10 rounded-full border-2 border-white/10 border-t-white animate-spin"></div>
                                <p>Carregando dados do upload selecionado...</p>
                            </div>
                            <div id="tableWrapper" class="hidden overflow-x-auto rounded-2xl border border-white/5">
                                <table class="min-w-full divide-y divide-white/5">
                                    <thead id="tableHead" class="bg-white/5 uppercase tracking-[0.2em] text-[11px] text-white/60"></thead>
                                    <tbody id="tableBody" class="divide-y divide-white/5 text-sm"></tbody>
                                </table>
                            </div>
                            <div id="hiddenRowsSection" class="hidden border border-white/10 rounded-2xl p-5 space-y-4 bg-white/5">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                    <div>
                                        <h4 class="text-sm font-semibold text-white/80 flex items-center gap-2">
                                            Linhas ocultas
                                            <span id="hiddenRowsCount" class="text-xs font-medium text-white/50"></span>
                                        </h4>
                                        <p id="hiddenRowsDescription" class="text-xs text-white/60 mt-1">
                                            Linhas ocultadas não serão exibidas na tabela nem utilizadas na criação de gráficos desta categoria.
                                        </p>
                                    </div>
                                    <button id="restoreAllHidden" class="hidden {{ theme.buttons.secondary }} px-4 py-2 rounded-full text-xs uppercase tracking-wide">
                                        Restaurar todas
                                    </button>
                                </div>
                                <div id="hiddenRowsList" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".csv,.xlsx">

    <div id="toastContainer" class="fixed bottom-6 right-6 z-[60] space-y-3"></div>

    <div id="deleteModal" class="fixed inset-0 z-[70] hidden px-4 items-center justify-center">
        <div id="deleteModalOverlay" class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm"></div>
        <div class="relative mx-auto w-full max-w-md glass-panel {{ theme.modal }} border border-white/10 rounded-3xl p-8 shadow-2xl shadow-emerald-500/20 flex flex-col gap-6">
            <div class="flex items-start justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-2xl bg-red-500/10 text-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M4.5 19.5l7.5-15 7.5 15h-15z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold tracking-tight">Excluir upload</h2>
                        <p id="deleteModalMessage" class="text-sm text-white/60 mt-1">Tem certeza que deseja excluir este upload?</p>
                    </div>
                </div>
                <button id="deleteModalClose" type="button" class="p-2 rounded-full border border-transparent text-white/40 hover:text-white/80 hover:border-white/20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-white/60">
                Essa ação não poderá ser desfeita e removerá o arquivo selecionado da categoria atual.
            </div>
            <div class="flex flex-col-reverse sm:flex-row sm:justify-end gap-3">
                <button id="deleteModalCancel" type="button" class="w-full sm:w-auto {{ theme.buttons.secondary }} px-5 py-2.5 rounded-full text-sm uppercase tracking-wide">
                    Cancelar
                </button>
                <button id="deleteModalConfirm" type="button" class="w-full sm:w-auto px-5 py-2.5 rounded-full text-sm uppercase tracking-wide bg-red-500/90 hover:bg-red-500 text-white transition-colors disabled:opacity-60 disabled:cursor-not-allowed">
                    <span id="deleteModalConfirmText">Excluir upload</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const workflowId = {{ workflow.id }};
        const categories = {{ categories | tojson }};
        const categoryStatus = {{ category_status | tojson }};
        const chartsViewUrl = "{{ url_for('analise_jp.analise_jp_charts_view', workflow_id=workflow.id) }}";
        let currentCategory = categories.length ? categories[0] : null;
        let uploadsCache = {};
        let activeUploadId = null;
        let pendingDeleteCategory = null;
        let pendingDeleteUploadId = null;

        const uploadButton = document.getElementById('uploadButton');
        const uploadSpinner = document.getElementById('uploadSpinner');
        const fileInput = document.getElementById('fileInput');
        const categoryList = document.getElementById('categoryList');
        const uploadsList = document.getElementById('uploadsList');
        const uploadsEmptyState = document.getElementById('uploadsEmptyState');
        const uploadsLoading = document.getElementById('uploadsLoading');
        const activeCategoryLabel = document.getElementById('activeCategoryLabel');
        const categoryTitle = document.getElementById('categoryTitle');
        const categorySubtitle = document.getElementById('categorySubtitle');
        const tableSubtitle = document.getElementById('tableSubtitle');
        const tableEmptyState = document.getElementById('tableEmptyState');
        const tableLoading = document.getElementById('tableLoading');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const activeUploadInfo = document.getElementById('activeUploadInfo');
        const tableEmptyStateMessage = tableEmptyState ? tableEmptyState.querySelector('p:last-child') : null;
        const hiddenRowsSection = document.getElementById('hiddenRowsSection');
        const hiddenRowsList = document.getElementById('hiddenRowsList');
        const hiddenRowsCount = document.getElementById('hiddenRowsCount');
        const hiddenRowsDescription = document.getElementById('hiddenRowsDescription');
        const defaultHiddenRowsDescription = hiddenRowsDescription ? hiddenRowsDescription.textContent : '';
        const restoreAllHiddenButton = document.getElementById('restoreAllHidden');
        const refreshButton = document.getElementById('refreshButton');
        const chartsButton = document.getElementById('chartsButton');
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalMessage = document.getElementById('deleteModalMessage');
        const deleteModalOverlay = document.getElementById('deleteModalOverlay');
        const deleteModalClose = document.getElementById('deleteModalClose');
        const deleteModalCancel = document.getElementById('deleteModalCancel');
        const deleteModalConfirm = document.getElementById('deleteModalConfirm');
        const deleteModalConfirmText = document.getElementById('deleteModalConfirmText');
        const datasetRequests = new Map();

        function arraysEqual(first, second) {
            if (first === second) {
                return true;
            }

            if (!Array.isArray(first) || !Array.isArray(second) || first.length !== second.length) {
                return false;
            }

            for (let index = 0; index < first.length; index += 1) {
                if (first[index] !== second[index]) {
                    return false;
                }
            }

            return true;
        }

        function replaceChildrenSafe(target, ...nodes) {
            if (!target) {
                return;
            }

            if (typeof target.replaceChildren === 'function') {
                target.replaceChildren(...nodes);
                return;
            }

            target.innerHTML = '';
            nodes.forEach(node => {
                if (node) {
                    target.appendChild(node);
                }
            });
        }

        function normaliseColumnName(column) {
            if (column === null || column === undefined) {
                return '';
            }

            try {
                return String(column)
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase();
            } catch (error) {
                return String(column).toLowerCase();
            }
        }

        function reorderColumns(columns) {
            if (!Array.isArray(columns) || columns.length === 0) {
                return [];
            }

            const entries = columns.map((column, index) => ({
                column,
                index,
                normalised: normaliseColumnName(column)
            }));

            const descriptionEntry = entries.find(entry => entry.normalised.includes('descricao'));
            if (!descriptionEntry) {
                return [...columns];
            }

            const ordered = [descriptionEntry.column];
            entries.forEach(entry => {
                if (entry.index !== descriptionEntry.index) {
                    ordered.push(entry.column);
                }
            });

            return ordered;
        }

        function slugToLabel(slug) {
            return slug
                .split('_')
                .map(word => word ? word.charAt(0).toUpperCase() + word.slice(1) : '')
                .join(' ');
        }

        function createCategoryCheckIcon() {
            const wrapper = document.createElement('span');
            wrapper.dataset.role = 'category-check';
            wrapper.setAttribute('aria-hidden', 'true');
            wrapper.className = 'hidden shrink-0 w-6 h-6 rounded-full border border-emerald-400/80 bg-emerald-500/10 text-emerald-300 flex items-center justify-center';

            const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            icon.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            icon.setAttribute('viewBox', '0 0 20 20');
            icon.setAttribute('fill', 'currentColor');
            icon.classList.add('w-4', 'h-4');

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('fill-rule', 'evenodd');
            path.setAttribute('clip-rule', 'evenodd');
            path.setAttribute('d', 'M16.704 5.29a1 1 0 0 1 .006 1.414l-7.25 7.333a1 1 0 0 1-1.437.011L3.29 9.313A1 1 0 1 1 4.71 7.89l3.6 3.565 6.534-6.602a1 1 0 0 1 1.414-.006Z');

            icon.appendChild(path);
            wrapper.appendChild(icon);
            return wrapper;
        }

        function updateCategoryCompletion(category, hasUploads) {
            if (!category) return;
            const normalisedHasUploads = Boolean(hasUploads);
            categoryStatus[category] = normalisedHasUploads;

            const button = categoryList.querySelector(`button[data-category="${category}"]`);
            if (!button) return;

            button.dataset.hasUploads = normalisedHasUploads ? 'true' : 'false';

            let checkIcon = button.querySelector('[data-role="category-check"]');
            if (!checkIcon) {
                const contentWrapper = button.querySelector('[data-role="category-content"]');
                if (!contentWrapper) {
                    return;
                }
                checkIcon = createCategoryCheckIcon();
                contentWrapper.appendChild(checkIcon);
            }

            if (normalisedHasUploads) {
                checkIcon.classList.remove('hidden');
                checkIcon.setAttribute('aria-hidden', 'false');
            } else {
                checkIcon.classList.add('hidden');
                checkIcon.setAttribute('aria-hidden', 'true');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `${type === 'success' ? '{{ theme.toast.success }}' : '{{ theme.toast.error }}'} px-4 py-3 rounded-2xl shadow-lg shadow-emerald-500/20 flex items-center gap-3 transition-all duration-300`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.classList.add('translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        function setUploadingState(isUploading) {
            if (!uploadButton) return;
            uploadButton.disabled = isUploading || !currentCategory;
            if (isUploading) {
                uploadSpinner.classList.remove('hidden');
            } else {
                uploadSpinner.classList.add('hidden');
            }
        }

        function setLoadingUploads(isLoading) {
            if (isLoading) {
                uploadsLoading.classList.remove('hidden');
            } else {
                uploadsLoading.classList.add('hidden');
            }
        }

        function setTableLoading(isLoading) {
            if (!tableLoading) {
                return;
            }

            if (isLoading) {
                tableLoading.classList.remove('hidden');
                tableEmptyState.classList.add('hidden');
                tableWrapper.classList.add('hidden');
            } else {
                tableLoading.classList.add('hidden');
            }
        }

        function updateCategoryHeader() {
            if (!currentCategory) {
                activeCategoryLabel.textContent = '-';
                categoryTitle.textContent = 'Selecione uma categoria';
                categorySubtitle.textContent = 'Envie um arquivo CSV ou XLSX para liberar a visualização dos dados.';
                refreshButton.classList.add('hidden');
                setUploadingState(false);
                return;
            }

            const label = slugToLabel(currentCategory);
            activeCategoryLabel.textContent = label;
            categoryTitle.textContent = label;
            categorySubtitle.textContent = 'Envie arquivos da categoria selecionada para visualizar a tabela dinâmica.';
            refreshButton.classList.remove('hidden');
            setUploadingState(false);
        }

        function clearTable() {
            replaceChildrenSafe(tableHead);
            replaceChildrenSafe(tableBody);
            setTableLoading(false);
            tableWrapper.classList.add('hidden');
            tableEmptyState.classList.remove('hidden');
            tableSubtitle.textContent = 'Selecione um upload para visualizar os dados extraídos.';
            activeUploadInfo.textContent = '';
            if (tableEmptyStateMessage) {
                tableEmptyStateMessage.textContent = 'Nenhum upload selecionado.';
            }
            if (hiddenRowsSection) {
                hiddenRowsSection.classList.add('hidden');
            }
            if (hiddenRowsList) {
                replaceChildrenSafe(hiddenRowsList);
            }
            if (hiddenRowsCount) {
                hiddenRowsCount.textContent = '';
            }
            if (hiddenRowsDescription) {
                hiddenRowsDescription.textContent = defaultHiddenRowsDescription;
                hiddenRowsDescription.classList.remove('text-amber-200');
            }
            if (restoreAllHiddenButton) {
                restoreAllHiddenButton.classList.add('hidden');
                restoreAllHiddenButton.disabled = false;
            }
        }

        function renderTable(records, upload) {
            if (!records || !records.length || !upload) {
                return;
            }

            const columns = reorderColumns(
                Object.keys(records[0]).filter(column => !column.startsWith('__'))
            );

            const headerRow = document.createElement('tr');
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = slugToLabel(column);
                th.className = 'px-4 py-3 text-left';
                headerRow.appendChild(th);
            });

            const actionTh = document.createElement('th');
            actionTh.textContent = 'Ações';
            actionTh.className = 'px-4 py-3 text-right';
            headerRow.appendChild(actionTh);

            replaceChildrenSafe(tableHead, headerRow);

            const bodyFragment = document.createDocumentFragment();
            records.forEach(record => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition-colors';
                columns.forEach(column => {
                    const td = document.createElement('td');
                    let value = record[column];
                    if (value === null || value === undefined || value === '') {
                        value = '-';
                    }
                    td.textContent = value;
                    td.className = 'px-4 py-3 align-top';
                    tr.appendChild(td);
                });

                const actionTd = document.createElement('td');
                actionTd.className = 'px-4 py-3 text-right align-top';

                const hideButton = document.createElement('button');
                hideButton.type = 'button';
                hideButton.className = 'text-xs uppercase tracking-widest px-3 py-1.5 rounded-full border border-white/10 hover:border-rose-400 hover:text-rose-300 transition-colors';
                hideButton.textContent = 'Ocultar';
                hideButton.addEventListener('click', () => {
                    if (hideButton.disabled) return;
                    hideButton.disabled = true;
                    hideButton.classList.add('opacity-60');
                    hideRow(upload, record.__rowIndex)
                        .finally(() => {
                            hideButton.disabled = false;
                            hideButton.classList.remove('opacity-60');
                        });
                });

                actionTd.appendChild(hideButton);
                tr.appendChild(actionTd);
                bodyFragment.appendChild(tr);
            });

            replaceChildrenSafe(tableBody, bodyFragment);
        }

        function highlightActiveUpload(uploadId) {
            const items = uploadsList.querySelectorAll('button[data-upload-id]');
            items.forEach(item => {
                if (parseInt(item.dataset.uploadId, 10) === uploadId) {
                    item.classList.add('border-emerald-400', 'bg-emerald-500/10');
                } else {
                    item.classList.remove('border-emerald-400', 'bg-emerald-500/10');
                }
            });
        }

        function renderUploads(category, uploads) {
            replaceChildrenSafe(uploadsList);

            const hasUploads = Array.isArray(uploads) && uploads.length > 0;
            updateCategoryCompletion(category, hasUploads);

            if (!hasUploads) {
                uploadsEmptyState.classList.remove('hidden');
                if (category === currentCategory) {
                    activeUploadId = null;
                    clearTable();
                }
                return;
            }

            uploadsEmptyState.classList.add('hidden');
            uploads.forEach(upload => normaliseUpload(upload, {
                datasetLoaded: upload.__datasetLoaded === true
            }));

            if (!uploads.some(upload => upload.id === activeUploadId)) {
                activeUploadId = uploads[0]?.id ?? null;
            }

            const fragment = document.createDocumentFragment();
            uploads.forEach(upload => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'flex items-center gap-3';

                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.uploadId = upload.id;
                button.className = 'flex-1 text-left px-5 py-4 rounded-2xl border border-white/10 bg-white/5 hover:border-emerald-400 transition-colors duration-300';

                const name = document.createElement('p');
                name.className = 'text-sm font-semibold text-white/80';
                name.textContent = upload.nome_arquivo;

                const meta = document.createElement('p');
                meta.className = 'text-xs text-white/50 mt-1';
                meta.textContent = upload.created_at ? new Date(upload.created_at).toLocaleString('pt-BR') : 'Data não disponível';

                button.appendChild(name);
                button.appendChild(meta);

                button.addEventListener('click', () => {
                    selectUpload(upload.id);
                });

                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'p-2 rounded-2xl border border-transparent text-white/60 hover:text-red-400 hover:border-red-400 transition-colors';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                `;
                deleteButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    openDeleteModal(category, upload);
                });

                itemWrapper.appendChild(button);
                itemWrapper.appendChild(deleteButton);

                fragment.appendChild(itemWrapper);
            });

            replaceChildrenSafe(uploadsList, fragment);

            if (category === currentCategory && activeUploadId !== null) {
                selectUpload(activeUploadId);
            } else {
                highlightActiveUpload(activeUploadId);
            }
        }

        function normaliseUpload(upload, options = {}) {
            if (!upload) {
                return upload;
            }

            const hasDatasetProperty = Object.prototype.hasOwnProperty.call(upload, 'dados_extraidos');
            const hasDatasetArray = Array.isArray(upload.dados_extraidos);

            if (!hasDatasetArray) {
                upload.dados_extraidos = [];
            }

            const hiddenValues = Array.isArray(upload.linhas_ocultas) ? upload.linhas_ocultas : [];
            const cleanedHidden = hiddenValues
                .map(value => Number.parseInt(value, 10))
                .filter(index => Number.isInteger(index) && index >= 0)
                .sort((a, b) => a - b);

            const uniqueHidden = Array.from(new Set(cleanedHidden));
            const currentHidden = Array.isArray(upload.linhas_ocultas) ? upload.linhas_ocultas : [];
            if (!arraysEqual(uniqueHidden, currentHidden)) {
                upload.linhas_ocultas = uniqueHidden;
                upload.__recordsCache = null;
            }

            if (options.datasetLoaded === true) {
                upload.__datasetLoaded = true;
                upload.__recordsCache = null;
            } else if (options.datasetLoaded === false) {
                upload.__datasetLoaded = false;
            } else if (!hasDatasetProperty && upload.__datasetLoaded === undefined) {
                upload.__datasetLoaded = false;
            } else if (hasDatasetArray && upload.__datasetLoaded === undefined) {
                upload.__datasetLoaded = true;
            }

            if (options.forceResetCache) {
                upload.__recordsCache = null;
            }

            return upload;
        }

        function getPreparedRecords(upload) {
            if (!upload || !Array.isArray(upload.dados_extraidos)) {
                return { all: [], visible: [], hidden: [] };
            }

            const hiddenIndices = Array.isArray(upload.linhas_ocultas) ? upload.linhas_ocultas : [];
            const cacheKey = `${upload.dados_extraidos.length}:${hiddenIndices.join(',')}`;
            if (upload.__recordsCache && upload.__recordsCache.key === cacheKey) {
                return upload.__recordsCache;
            }

            const hiddenSet = new Set(hiddenIndices);
            const allRecords = [];
            const visibleRecords = [];
            const hiddenRecords = [];

            upload.dados_extraidos.forEach((row, index) => {
                const entry = { __rowIndex: index, __hidden: hiddenSet.has(index) };

                if (row && typeof row === 'object' && !Array.isArray(row)) {
                    Object.keys(row).forEach(key => {
                        entry[key] = row[key];
                    });
                }

                allRecords.push(entry);
                if (entry.__hidden) {
                    hiddenRecords.push(entry);
                } else {
                    visibleRecords.push(entry);
                }
            });

            const cache = {
                key: cacheKey,
                all: allRecords,
                visible: visibleRecords,
                hidden: hiddenRecords
            };

            upload.__recordsCache = cache;
            return cache;
        }

        function updateActiveUploadInfo(upload) {
            if (!activeUploadInfo) {
                return;
            }

            if (!upload) {
                activeUploadInfo.textContent = '';
                return;
            }

            const parts = [];
            if (upload.nome_arquivo) {
                parts.push(`Arquivo selecionado: ${upload.nome_arquivo}`);
            }

            const hiddenCount = Array.isArray(upload.linhas_ocultas) ? upload.linhas_ocultas.length : 0;
            if (hiddenCount > 0) {
                parts.push(hiddenCount === 1 ? '1 linha ocultada' : `${hiddenCount} linhas ocultadas`);
            }

            activeUploadInfo.textContent = parts.join(' • ');
        }

        function renderHiddenRows(upload, providedHiddenRecords) {
            if (!hiddenRowsSection || !hiddenRowsList) {
                return;
            }

            const hiddenRecords = Array.isArray(providedHiddenRecords)
                ? providedHiddenRecords
                : getPreparedRecords(upload).hidden;

            replaceChildrenSafe(hiddenRowsList);

            if (!hiddenRecords.length) {
                hiddenRowsSection.classList.add('hidden');
                if (hiddenRowsCount) {
                    hiddenRowsCount.textContent = '';
                }
                if (hiddenRowsDescription) {
                    hiddenRowsDescription.textContent = defaultHiddenRowsDescription;
                    hiddenRowsDescription.classList.remove('text-amber-200');
                }
                if (restoreAllHiddenButton) {
                    restoreAllHiddenButton.classList.add('hidden');
                    restoreAllHiddenButton.disabled = false;
                    restoreAllHiddenButton.onclick = null;
                }
                return;
            }

            hiddenRowsSection.classList.remove('hidden');
            if (hiddenRowsCount) {
                hiddenRowsCount.textContent = hiddenRecords.length === 1
                    ? '(1 linha)'
                    : `(${hiddenRecords.length} linhas)`;
            }
            if (hiddenRowsDescription) {
                hiddenRowsDescription.textContent = 'As linhas abaixo foram ocultadas e não aparecerão na tabela ou nos gráficos.';
                hiddenRowsDescription.classList.add('text-amber-200');
            }

            const previewFields = reorderColumns(
                Object.keys(hiddenRecords[0]).filter(key => !key.startsWith('__'))
            );

            const fragment = document.createDocumentFragment();
            hiddenRecords.forEach(record => {
                const item = document.createElement('div');
                item.className = 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-3';

                const preview = document.createElement('div');
                preview.className = 'text-sm text-white/70';
                const previewValues = previewFields
                    .map(field => record[field])
                    .filter(value => value !== null && value !== undefined && String(value).trim() !== '')
                    .slice(0, 3);
                preview.textContent = previewValues.length
                    ? previewValues.join(' • ')
                    : `Linha ${record.__rowIndex + 1}`;

                const actionsWrapper = document.createElement('div');
                actionsWrapper.className = 'flex items-center gap-2 justify-end sm:justify-start';

                const restoreButton = document.createElement('button');
                restoreButton.type = 'button';
                restoreButton.className = 'text-xs uppercase tracking-widest px-3 py-1.5 rounded-full border border-white/10 hover:border-emerald-400 hover:text-emerald-200 transition-colors';
                restoreButton.textContent = 'Restaurar linha';
                restoreButton.addEventListener('click', () => {
                    if (restoreButton.disabled) return;
                    restoreButton.disabled = true;
                    restoreHiddenRows(upload, [record.__rowIndex])
                        .finally(() => {
                            restoreButton.disabled = false;
                        });
                });

                actionsWrapper.appendChild(restoreButton);
                item.appendChild(preview);
                item.appendChild(actionsWrapper);

                fragment.appendChild(item);
            });

            replaceChildrenSafe(hiddenRowsList, fragment);

            if (restoreAllHiddenButton) {
                restoreAllHiddenButton.classList.remove('hidden');
                restoreAllHiddenButton.disabled = false;
                restoreAllHiddenButton.onclick = () => {
                    if (restoreAllHiddenButton.disabled) return;
                    restoreAllHiddenButton.disabled = true;
                    const indices = hiddenRecords.map(record => record.__rowIndex);
                    restoreHiddenRows(upload, indices)
                        .finally(() => {
                            restoreAllHiddenButton.disabled = false;
                        });
                };
            }
        }

        function renderTableForUpload(upload) {
            if (!upload) {
                clearTable();
                return;
            }

            normaliseUpload(upload);

            if (!upload.__datasetLoaded) {
                setTableLoading(true);
                tableEmptyState.classList.add('hidden');
                tableWrapper.classList.add('hidden');

                ensureUploadDataset(upload)
                    .then(resolvedUpload => {
                        if (resolvedUpload && activeUploadId === resolvedUpload.id) {
                            renderTableForUpload(resolvedUpload);
                        }
                    })
                    .catch(error => {
                        setTableLoading(false);
                        showToast(error.message || 'Falha ao carregar os dados do upload selecionado.', 'error');
                        if (activeUploadId === upload.id) {
                            clearTable();
                            if (tableEmptyStateMessage) {
                                tableEmptyStateMessage.textContent = 'Não foi possível carregar os dados deste upload.';
                            }
                        }
                    });

                return;
            }

            setTableLoading(false);

            const prepared = getPreparedRecords(upload);
            const visibleRecords = prepared.visible;
            const hiddenCount = prepared.hidden.length;

            if (!visibleRecords.length) {
                replaceChildrenSafe(tableHead);
                replaceChildrenSafe(tableBody);
                tableWrapper.classList.add('hidden');
                tableEmptyState.classList.remove('hidden');
                if (tableEmptyStateMessage) {
                    tableEmptyStateMessage.textContent = hiddenCount
                        ? 'Todas as linhas deste upload estão ocultas. Utilize a seção abaixo para restaurá-las.'
                        : 'Nenhum dado disponível para este upload.';
                }
                tableSubtitle.textContent = hiddenCount
                    ? 'Todas as linhas visíveis foram ocultadas para esta categoria.'
                    : 'Nenhum dado disponível para este upload.';
            } else {
                renderTable(visibleRecords, upload);
                tableWrapper.classList.remove('hidden');
                tableEmptyState.classList.add('hidden');
                if (tableEmptyStateMessage) {
                    tableEmptyStateMessage.textContent = 'Nenhum upload selecionado.';
                }
                tableSubtitle.textContent = `Visualizando dados de ${slugToLabel(currentCategory)}.`;
            }

            updateActiveUploadInfo(upload);
            renderHiddenRows(upload, prepared.hidden);
        }

        function buildDatasetUrl(upload) {
            if (!upload || !upload.id) {
                return null;
            }

            const categoria = upload.categoria || currentCategory;
            if (!categoria) {
                return null;
            }

            return `/analise_jp/${workflowId}/uploads/${encodeURIComponent(categoria)}/${upload.id}/dataset`;
        }

        function fetchUploadDataset(upload) {
            const url = buildDatasetUrl(upload);
            if (!url) {
                return Promise.reject(new Error('Não foi possível carregar os dados do upload selecionado.'));
            }

            if (datasetRequests.has(url)) {
                return datasetRequests.get(url);
            }

            const request = fetch(url)
                .then(async response => {
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data.error || 'Falha ao carregar os dados do upload selecionado.');
                    }

                    if (!data.upload) {
                        throw new Error('Resposta do servidor inválida.');
                    }

                    Object.assign(upload, data.upload);
                    normaliseUpload(upload, { datasetLoaded: true, forceResetCache: true });

                    const categoria = upload.categoria || currentCategory;
                    if (categoria) {
                        const cachedUploads = uploadsCache[categoria];
                        if (Array.isArray(cachedUploads)) {
                            const existingIndex = cachedUploads.findIndex(item => item.id === upload.id);
                            if (existingIndex !== -1) {
                                cachedUploads[existingIndex] = upload;
                            } else {
                                cachedUploads.unshift(upload);
                            }
                        } else {
                            uploadsCache[categoria] = [upload];
                        }
                    }

                    return upload;
                })
                .finally(() => {
                    datasetRequests.delete(url);
                });

            datasetRequests.set(url, request);
            return request;
        }

        function ensureUploadDataset(upload) {
            if (upload && upload.__datasetLoaded) {
                return Promise.resolve(upload);
            }

            return fetchUploadDataset(upload);
        }

        function buildHiddenRowsUrl(upload) {
            if (!upload || !upload.id) {
                return null;
            }
            const categoria = upload.categoria || currentCategory;
            if (!categoria) {
                return null;
            }
            return `/analise_jp/${workflowId}/uploads/${encodeURIComponent(categoria)}/${upload.id}/linhas_ocultas`;
        }

        function updateRowVisibility(upload, indices, action) {
            const url = buildHiddenRowsUrl(upload);
            if (!url || !Array.isArray(indices) || !indices.length) {
                return Promise.reject(new Error('Não foi possível atualizar a visibilidade da linha selecionada.'));
            }

            return fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ acao: action, indices })
            })
                .then(async response => {
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data.error || 'Falha ao atualizar a visibilidade da linha.');
                    }

                    const normalisedHidden = Array.isArray(data.linhas_ocultas)
                        ? data.linhas_ocultas
                            .map(value => Number.parseInt(value, 10))
                            .filter(index => Number.isInteger(index) && index >= 0)
                            .sort((a, b) => a - b)
                        : [];

                    upload.linhas_ocultas = normalisedHidden;
                    upload.__recordsCache = null;

                    const categoria = upload.categoria || currentCategory;
                    if (categoria && Array.isArray(uploadsCache[categoria])) {
                        const cachedUpload = uploadsCache[categoria].find(item => item.id === upload.id);
                        if (cachedUpload && cachedUpload !== upload) {
                            cachedUpload.linhas_ocultas = [...normalisedHidden];
                            cachedUpload.__recordsCache = null;
                        }
                    }

                    renderTableForUpload(upload);
                    highlightActiveUpload(upload.id);
                    showToast(data.message || 'Linhas atualizadas com sucesso.');
                    return data;
                })
                .catch(error => {
                    showToast(error.message || 'Falha ao atualizar a visibilidade da linha.', 'error');
                    throw error;
                });
        }

        function hideRow(upload, rowIndex) {
            if (!upload) {
                return Promise.resolve();
            }

            const targetIndex = Number.parseInt(rowIndex, 10);
            if (!Number.isInteger(targetIndex)) {
                return Promise.resolve();
            }

            return updateRowVisibility(upload, [targetIndex], 'ocultar');
        }

        function restoreHiddenRows(upload, indices) {
            if (!upload) {
                return Promise.resolve();
            }

            const values = Array.isArray(indices) ? indices : [indices];
            const cleaned = values
                .map(value => Number.parseInt(value, 10))
                .filter(Number.isInteger);

            if (!cleaned.length) {
                return Promise.resolve();
            }

            return updateRowVisibility(upload, cleaned, 'restaurar');
        }

        function selectUpload(uploadId) {
            const uploads = uploadsCache[currentCategory] || [];
            const upload = uploads.find(item => item.id === uploadId);

            if (!upload) {
                if (uploads.length) {
                    activeUploadId = uploads[0].id;
                    highlightActiveUpload(activeUploadId);
                    renderTableForUpload(uploads[0]);
                } else {
                    activeUploadId = null;
                    clearTable();
                }
                return;
            }

            activeUploadId = uploadId;
            highlightActiveUpload(uploadId);
            renderTableForUpload(upload);
        }

        function deleteUpload(category, uploadId) {
            if (!category || !uploadId) return;

            fetch(`/analise_jp/${workflowId}/uploads/${category}/${uploadId}`, {
                method: 'DELETE'
            })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        showToast(data.error || 'Falha ao excluir o upload.', 'error');
                        setDeleteModalLoading(false);
                        return;
                    }

                    showToast(data.message || 'Upload removido com sucesso.');

                    if (uploadsCache[category]) {
                        uploadsCache[category] = uploadsCache[category].filter(item => item.id !== uploadId);
                    }

                    if (activeUploadId === uploadId) {
                        activeUploadId = null;
                        clearTable();
                    }

                    renderUploads(category, uploadsCache[category] || []);
                    setDeleteModalLoading(false);
                    closeDeleteModal();
                })
                .catch(() => {
                    showToast('Falha ao excluir o upload.', 'error');
                    setDeleteModalLoading(false);
                });
        }

        function openDeleteModal(category, upload) {
            pendingDeleteCategory = category;
            pendingDeleteUploadId = upload?.id ?? null;
            setDeleteModalLoading(false);

            deleteModalMessage.textContent = upload?.nome_arquivo
                ? `Tem certeza que deseja excluir o upload "${upload.nome_arquivo}"?`
                : 'Tem certeza que deseja excluir este upload?';

            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
            deleteModal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('overflow-hidden');
            deleteModalConfirm.focus();
        }

        function closeDeleteModal() {
            pendingDeleteCategory = null;
            pendingDeleteUploadId = null;
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
            deleteModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('overflow-hidden');
        }

        function setDeleteModalLoading(isLoading) {
            if (isLoading) {
                deleteModalConfirm.disabled = true;
                deleteModalConfirmText.textContent = 'Excluindo...';
            } else {
                deleteModalConfirm.disabled = false;
                deleteModalConfirmText.textContent = 'Excluir upload';
            }
        }

        const dismissDeleteModal = () => {
            if (deleteModalConfirm.disabled) return;
            closeDeleteModal();
        };

        deleteModalOverlay.addEventListener('click', dismissDeleteModal);
        deleteModalClose.addEventListener('click', dismissDeleteModal);
        deleteModalCancel.addEventListener('click', dismissDeleteModal);
        deleteModalConfirm.addEventListener('click', () => {
            if (!pendingDeleteCategory || !pendingDeleteUploadId) return;
            setDeleteModalLoading(true);
            deleteUpload(pendingDeleteCategory, pendingDeleteUploadId);
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !deleteModal.classList.contains('hidden')) {
                event.preventDefault();
                if (!deleteModalConfirm.disabled) {
                    closeDeleteModal();
                }
            }
        });

        function setActiveCategory(category) {
            currentCategory = category;
            activeUploadId = null;
            updateCategoryHeader();

            Array.from(categoryList.querySelectorAll('button[data-category]')).forEach(button => {
                if (button.dataset.category === category) {
                    button.classList.add('border-emerald-400', 'bg-emerald-500/10', 'text-white');
                } else {
                    button.classList.remove('border-emerald-400', 'bg-emerald-500/10', 'text-white');
                }
            });

            if (!category) {
                uploadsList.innerHTML = '';
                uploadsEmptyState.classList.remove('hidden');
                clearTable();
                return;
            }

            if (uploadsCache[category]) {
                renderUploads(category, uploadsCache[category]);
            } else {
                loadUploads(category);
            }
        }

        function createCategoryButtons() {
            if (!categories.length) {
                categoryList.innerHTML = '<p class="text-sm text-white/60">Nenhuma categoria configurada.</p>';
                uploadButton.disabled = true;
                return;
            }

            categories.forEach(category => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.category = category;
                button.className = 'w-full px-4 py-2.5 rounded-2xl border border-white/10 bg-white/5 hover:border-emerald-400 transition-colors duration-300 text-white/70 flex items-center justify-between gap-3';

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'flex items-center justify-between gap-3 w-full';
                contentWrapper.dataset.role = 'category-content';

                const labelSpan = document.createElement('span');
                labelSpan.className = 'text-sm font-medium tracking-tight';
                labelSpan.textContent = slugToLabel(category);

                const checkIcon = createCategoryCheckIcon();
                if (categoryStatus?.[category]) {
                    checkIcon.classList.remove('hidden');
                    checkIcon.setAttribute('aria-hidden', 'false');
                }

                contentWrapper.appendChild(labelSpan);
                contentWrapper.appendChild(checkIcon);
                button.appendChild(contentWrapper);

                button.addEventListener('click', () => setActiveCategory(category));
                categoryList.appendChild(button);
                updateCategoryCompletion(category, categoryStatus?.[category]);
            });
        }

        function loadUploads(category) {
            if (!category) return;
            setLoadingUploads(true);
            uploadsList.innerHTML = '';
            uploadsEmptyState.classList.add('hidden');
            clearTable();

            fetch(`/analise_jp/${workflowId}/uploads/${category}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                        uploadsEmptyState.classList.remove('hidden');
                        return;
                    }
                    const uploads = (data.uploads || []).map(upload => {
                        const hasDataset = Object.prototype.hasOwnProperty.call(upload, 'dados_extraidos');
                        return normaliseUpload(upload, {
                            datasetLoaded: hasDataset,
                            forceResetCache: true
                        });
                    });
                    uploadsCache[category] = uploads;
                    renderUploads(category, uploads);
                })
                .catch(() => {
                    showToast('Falha ao carregar uploads.', 'error');
                    uploadsEmptyState.classList.remove('hidden');
                })
                .finally(() => {
                    setLoadingUploads(false);
                });
        }

        function uploadFileForCategory() {
            if (!currentCategory) {
                showToast('Selecione uma categoria antes de enviar o arquivo.', 'error');
                return;
            }

            const file = fileInput.files[0];
            if (!file) {
                return;
            }

            const formData = new FormData();
            formData.append('arquivo', file);

            setUploadingState(true);
            showToast('Processando upload...', 'success');

            fetch(`/analise_jp/${workflowId}/upload/${currentCategory}`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                        return;
                    }

                    showToast(data.message || 'Upload realizado com sucesso!', 'success');
                    fileInput.value = '';
                    const newUpload = normaliseUpload(data.upload, {
                        datasetLoaded: true,
                        forceResetCache: true
                    });
                    uploadsCache[currentCategory] = [newUpload, ...(uploadsCache[currentCategory] || [])];
                    activeUploadId = newUpload.id;
                    renderUploads(currentCategory, uploadsCache[currentCategory]);
                    highlightActiveCategoryButton();
                })
                .catch(() => {
                    showToast('Falha ao enviar o arquivo.', 'error');
                })
                .finally(() => {
                    setUploadingState(false);
                });
        }

        function highlightActiveCategoryButton() {
            Array.from(categoryList.querySelectorAll('button[data-category]')).forEach(button => {
                if (button.dataset.category === currentCategory) {
                    button.classList.add('border-emerald-400', 'bg-emerald-500/10', 'text-white');
                } else {
                    button.classList.remove('border-emerald-400', 'bg-emerald-500/10', 'text-white');
                }
            });
        }

        function initEvents() {
            if (uploadButton) {
                uploadButton.addEventListener('click', () => {
                    if (!currentCategory) {
                        showToast('Selecione uma categoria antes de enviar o arquivo.', 'error');
                        return;
                    }
                    fileInput.click();
                });
            }

            if (chartsButton && chartsViewUrl) {
                chartsButton.addEventListener('click', () => {
                    window.location.href = chartsViewUrl;
                });
            }

            fileInput.addEventListener('change', () => {
                if (fileInput.files && fileInput.files[0]) {
                    uploadFileForCategory();
                }
            });

            if (refreshButton) {
                refreshButton.addEventListener('click', () => {
                    if (currentCategory) {
                        loadUploads(currentCategory);
                    }
                });
            }
        }

        function logout() {
            fetch('/logout')
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        window.location.href = '/';
                    }
                });
        }

        function changeTheme(theme) {
            fetch(`/theme/${theme}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).then(response => {
                if (response.ok) window.location.reload();
            });
        }

        function createThemeMenu() {
            if (document.getElementById('themeMenuContainer')) {
                return;
            }

            if (!document.getElementById('menuPortal')) return;

            const menuContainer = document.createElement('div');
            menuContainer.id = 'themeMenuContainer';
            menuContainer.style.position = 'fixed';
            menuContainer.style.top = '0';
            menuContainer.style.left = '0';
            menuContainer.style.width = '100vw';
            menuContainer.style.height = '100vh';
            menuContainer.style.pointerEvents = 'none';
            menuContainer.style.zIndex = '99999';
            document.body.appendChild(menuContainer);

            const menu = document.createElement('div');
            menu.id = 'themeMenu';
            menu.className = 'hidden {{ theme.modal }} rounded-lg shadow-xl py-1 w-56';
            menu.style.position = 'absolute';
            menu.style.pointerEvents = 'auto';

            const themes = [
                { name: 'Escuro', value: 'dark', preview: 'bg-gradient-to-r from-gray-900 via-gray-800 to-gray-700' },
                { name: 'Claro', value: 'light', preview: 'bg-gradient-to-r from-blue-500 via-white to-gray-100' },
                { name: 'Neon', value: 'neon', preview: 'bg-gradient-to-r from-purple-600 via-green-400 to-black' },
                { name: 'Futurista', value: 'futurist', preview: 'bg-gradient-to-r from-blue-600 via-cyan-400 to-purple-600' }
            ];

            themes.forEach(themeOption => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'block px-4 py-2 text-sm hover:{{ theme.accent }} flex items-center justify-between';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex items-center gap-3';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = themeOption.name;

                const previewDiv = document.createElement('div');
                previewDiv.className = `w-5 h-5 rounded-full ${themeOption.preview} border border-gray-400/20`;

                contentDiv.appendChild(previewDiv);
                contentDiv.appendChild(nameSpan);
                link.appendChild(contentDiv);

                link.onclick = (e) => {
                    e.preventDefault();
                    changeTheme(themeOption.value);
                    const menuEl = document.getElementById('themeMenu');
                    if (menuEl) {
                        menuEl.classList.add('hidden');
                    }
                };

                menu.appendChild(link);
            });

            menuContainer.appendChild(menu);
        }

        function toggleThemeMenu(event) {
            const menu = document.getElementById('themeMenu');
            if (!menu) return;

            const button = event.currentTarget;
            const buttonRect = button.getBoundingClientRect();

            if (menu.classList.contains('hidden')) {
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                const menuHeight = 200;
                const menuWidth = 240;

                let topPosition = buttonRect.top;
                let leftPosition = buttonRect.right + 12;

                if (buttonRect.top + menuHeight > viewportHeight) {
                    topPosition = Math.max(16, buttonRect.bottom - menuHeight);
                }

                if (leftPosition + menuWidth > viewportWidth) {
                    leftPosition = Math.max(16, buttonRect.left - menuWidth - 12);
                }

                menu.style.top = `${topPosition}px`;
                menu.style.left = `${leftPosition}px`;
                menu.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
            }
        }

        function openUserProfile() {
            console.log('Open user profile');
        }

        document.addEventListener('DOMContentLoaded', () => {
            createCategoryButtons();
            initEvents();
            createThemeMenu();
            if (currentCategory) {
                setActiveCategory(currentCategory);
            } else {
                updateCategoryHeader();
            }

            document.addEventListener('click', function(event) {
                const menu = document.getElementById('themeMenu');
                if (!menu || menu.classList.contains('hidden')) return;
                const isThemeButton = event.target.closest('button[title="Alterar Tema"]');
                if (!isThemeButton && !menu.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
